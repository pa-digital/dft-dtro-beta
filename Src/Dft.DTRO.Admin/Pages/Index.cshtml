@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="text-center" style="margin-top: 50px; margin-bottom: 50px">
    <h1 class="display-4">Dft DTRO</h1>
    <p>Dashboard</p>
</div>


<form method="post" style="display: flex;">
    <div id="first">

    
    <div class="options-container" style="accent-color">
        <label>
            <input type="radio" name="PeriodOption" value="days" checked /> Days
        </label>
        <label>
            <input type="radio" name="PeriodOption" value="weeks" /> Weeks
        </label>
        <label>
            <input type="radio" name="PeriodOption" value="months" /> Months
        </label>
    
        <select id="numberSelect" name="NumberSelect">
            @for (int i = 1; i <= 31; i++)
            {
                <option value="@i">@i</option>
            }
        </select>
    </div>
    <div style="margin-top: 10px; width: 300px;">
        <div style="display: flex; align-items: center;">
            <label style="margin-right: 10px;">TRA</label>
            <input type="text" id="traSearch" placeholder="Search..." style="margin-right: 10px;">
            <button class="btn btn-primary" type="submit">Update</button>
        </div>
        <div id="traSelectContainer" style="margin-top: 10px;">
            <div id="traSelect" class="select-items" style="width: 100%;">
                @{
                    var first = true;
                    foreach (var item in Model.LookupResponses)
                    {
                        if (!first)
                        {
                            <div style="width: 100%;" class="item" data-value="@item.Id">
                                @item.Name <span style="opacity: 0.5;">(@item.Id)</span>
                            </div>
                        }
                        else
                        {
                            <div style="width: 100%;" class="item" data-value="@item.Id">@item.Name</div>
                            first = false;
                        }
                    }
                }
            </div>
            <input type="hidden" id="selectedValue" name="TraSelect" />
        </div>
    </div>
    </div>


    <div id="second"  style="display: flex;">
    <div id="metrics" style="grey; padding: 10px; flex: 1; position: relative;">
        <div style="display: flex; justify-content: center; align-items: center; height: 30vh;">
            <div style="position: relative; width: 70vh;">
                <canvas id="metricSummaryChart"></canvas>

                <div id="stats" style="position: absolute; bottom: 0; right: 0;">
                    <div style="padding: 10px; flex: 1;">
                        <div class="checkbox-container" style="border: 1px solid lightgrey; padding: 10px;border-radius: 5px;">
                            <div style="margin-bottom: 10px; display: flex; align-items: center; justify-content: flex-end;">
                                <span>Api Health</span>
                                <div style="display: inline-block; width: 20px; height: 20px; background-color: @(Model.HealthApi ? "rgba(119, 221, 119, 0.5)" : "rgba(255, 105, 97, 0.5)"); /* pastel green or pastel red with 50% transparency */ border: 1px solid grey; border-radius: 5px; margin-left: 10px;"></div>
                            </div>
                            <div style="margin-bottom: 10px; display: flex; align-items: center; justify-content: flex-end;">
                                <span>TRA Id Match</span>
                                <div style="display: inline-block; width: 20px; height: 20px; background-color: @(Model.TraIdMatch ? "rgba(119, 221, 119, 0.5)" : "rgba(255, 105, 97, 0.5)"); /* pastel green or pastel red with 50% transparency */ border: 1px solid grey; border-radius: 5px; margin-left: 10px;"></div>
                            </div>
                            <div style="margin-bottom: 10px; display: flex; align-items: center; justify-content: flex-end;">
                                <span>Database Health</span>
                                <div style="display: inline-block; width: 20px; height: 20px; background-color: @(Model.HealthDatabase ? "rgba(119, 221, 119, 0.5)" : "rgba(255, 105, 97, 0.5)"); /* pastel green or pastel red with 50% transparency */ border: 1px solid grey; border-radius: 5px; margin-left: 10px;"></div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</form>


@section Scripts {

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const periodOptions = document.querySelectorAll('input[name="PeriodOption"]');
            const numberSelect = document.getElementById('numberSelect');
            const traSearch = document.getElementById('traSearch');
            const traSelectContainer = document.getElementById('traSelectContainer');
            const traSelect = document.getElementById('traSelect');
            const selectedValueInput = document.getElementById('selectedValue');
            let selectedItemId = null; // Track the currently selected item ID
            let firstFocus = true; // Flag to track first focus

            // Event listener for period options (days, weeks, months)
            periodOptions.forEach(option => {
                option.addEventListener('change', function () {
                    let max = 7;
                    switch (this.value) {
                        case 'days':
                            max = 7;
                            break;
                        case 'weeks':
                            max = 4;
                            break;
                        case 'months':
                            max = 6;
                            break;
                    }

                    // Update the number select options
                    numberSelect.innerHTML = '';
                    for (let i = 1; i <= max; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        if (i == 1) {
                            option.selected = true;
                        }
                        numberSelect.appendChild(option);
                    }
                });
            });

            // Event listener for search input on traSelect
            traSearch.addEventListener('keyup', function () {
                const searchValue = traSearch.value.trim().toLowerCase();
                const items = traSelectContainer.getElementsByClassName('item');

                // Check if search value contains a number
                const searchContainsNumber = /\d/.test(searchValue);

                // Loop through each item and toggle display based on search value
                Array.from(items).forEach(item => {
                    const itemId = item.getAttribute('data-value');
                    const itemName = item.textContent.trim().toLowerCase();

                    // Show item if matches search text or if search contains a number and item ID contains that number
                    if (itemName.includes(searchValue) || (searchContainsNumber && itemId.includes(searchValue))) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Clear selection highlight and reset selected item ID when search changes
                clearSelection();
                selectedItemId = null;
            });

            // Event listener for selecting an item in traSelect
            traSelectContainer.addEventListener('click', function (event) {
                if (event.target.classList.contains('item')) {
                    const selectedItem = event.target;
                    selectedItemId = selectedItem.getAttribute('data-value');
                    const selectedItemName = selectedItem.textContent.trim(); // Get the text content of the selected item

                    // Remove selection from previously selected item
                    clearSelection();

                    // Add selection to the clicked item
                    selectedItem.classList.add('selected-InList');

                    // Update the hidden input value
                    selectedValueInput.value = selectedItemId;

                    // Update the search text box with the selected item's name
                    traSearch.value = selectedItemName;

                    // Reset firstFocus flag when an item is selected
                    firstFocus = false;
                }
            });

            // Set the search text box with the first item's name if LookupResponses has values
            if (@Model.LookupResponses.Count > 0) {
                traSearch.value = "@Html.Raw(Model.LookupResponses[0].Name)"; // Ensure proper encoding and escaping
            }

            // Event listener to clear search text box on first focus
            traSearch.addEventListener('focus', function () {
                if (firstFocus) {
                    traSearch.value = ''; // Clear the search text box
                    firstFocus = false; // Update firstFocus flag
                }
            });

            // Function to clear selection highlight
            function clearSelection() {
                const selectedItems = traSelectContainer.querySelectorAll('.item.selected-InList');
                selectedItems.forEach(item => {
                    item.classList.remove('selected-InList');
                });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var canvas = document.getElementById('metricSummaryChart');
            var ctx = canvas.getContext('2d');

            var minimalValue = 0.01; // very small value to ensure visibility of zero-value slices

            var dataValues = [
        @Model.Metrics.SystemFailureCount,
        @Model.Metrics.SubmissionFailureCount,
        @Model.Metrics.SubmissionCount,
        @Model.Metrics.DeletionCount,
        @Model.Metrics.SearchCount,
        @Model.Metrics.EventCount
                    ];

            var total = dataValues.reduce((acc, curr) => acc + curr, 0);

            var dataLabels = [
                'SystemFailure (' + (@Model.Metrics.SystemFailureCount > 0 ? @Model.Metrics.SystemFailureCount : 0) + ')',
                'SubmissionFailure (' + (@Model.Metrics.SubmissionFailureCount > 0 ? @Model.Metrics.SubmissionFailureCount : 0) + ')',
                'Submission (' + (@Model.Metrics.SubmissionCount > 0 ? @Model.Metrics.SubmissionCount : 0) + ')',
                'Deletion (' + (@Model.Metrics.DeletionCount > 0 ? @Model.Metrics.DeletionCount : 0) + ')',
                'Search (' + (@Model.Metrics.SearchCount > 0 ? @Model.Metrics.SearchCount : 0) + ')',
                'Event (' + (@Model.Metrics.EventCount > 0 ? @Model.Metrics.EventCount : 0) + ')'
            ];

            // Check if all values are zero
            if (total === 0) {
                dataValues = [0];
                dataLabels = ['No data'];
            }

            var data = {
                labels: dataLabels,
                datasets: [{
                    data: dataValues.map(value => value > 0 ? value : minimalValue),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)', // pastel red
                        'rgba(255, 159, 64, 0.5)',  // pastel orange
                        'rgb(144, 238, 144,0.5)',  // pastel green
                        'rgba(54, 162, 235, 0.5)',  // pastel dark blue
                        'rgba(153, 102, 255, 0.5)', // pastel blue
                        'rgba(201, 203, 207, 0.5)'  // pastel light blue
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(201, 203, 207, 1)'
                    ],
                    borderWidth: 1,
                    hoverOffset: 10
                }]
            };

            var totalSubmissions = @Model.Metrics.SubmissionCount + @Model.Metrics.SubmissionFailureCount;
            var submissionPercentage = totalSubmissions > 0 ? (@Model.Metrics.SubmissionCount / totalSubmissions * 100).toFixed(2) : 0;

                var options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right',
                        align: 'start'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (tooltipItem) { return ''; }
                        }
                    }
                },
                cutout: '70%',
                elements: {
                    arc: {
                        borderWidth: 2,
                        borderColor: '#fff'
                    }
                },
                radius: '90%'
            };

            var textInMiddle = "";
            if (total === 0) {
                textInMiddle = "No data";
            }
            else {
                textInMiddle = Math.round(submissionPercentage) + "%";
            }

            var centerTextPlugin = {
                id: 'centerText',
                beforeDraw: function (chart) {
                    var width = chart.chartArea.right - chart.chartArea.left,
                        height = chart.chartArea.bottom - chart.chartArea.top,
                        ctx = chart.ctx;

                    ctx.restore();
                    var fontSize = (height / 228).toFixed(2);
                    ctx.font = fontSize + "em sans-serif";
                    ctx.textBaseline = "middle";

                    var text = textInMiddle,
                        textX = Math.round((width - ctx.measureText(text).width) / 2),
                        textY = height / 2;

                    ctx.fillText(text, textX, textY);
                    ctx.save();
                }
            };

            Chart.register(centerTextPlugin);

            var metricSummaryChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: options
            });

            metricSummaryChart.update();
        });
    </script>

}


